<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Game Loading...</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e74c3c">
    <meta name="description"
        content="A place for all nostalgic gamers to relive old memories. ReLived by Shardul Pakhale.">
    <meta property="og:image" content="http://retrogamezone.droppages.com/nesicon.png">
    <meta property="og:title" content="Retro Game Zone - By Shardul Pakhale">
    <meta property="og:description"
        content="A place for all nostalgic gamers to relive old memories. ReLived by Shardul Pakhale.">
    <link rel="apple-touch-icon" href="http://retrogamezone.droppages.com/nesicon.png">
    <link rel="apple-touch-startup-image" href="http://retrogamezone.droppages.com/nesicon.png">
    <link rel="Shortcut Icon" href="favicon.ico" type="image/x-icon">
    <link rel="Bookmark" href="favicon.ico">
    <link rel="stylesheet" href="assets/css/main.css" />
    <style>
        .infoDiv {
            padding: 1em;
            border: dashed 2px rgba(211, 47, 47, 0.5);
            margin: 1em;
            background: rgba(255, 205, 210, 0.5);
            transition: all 1s ease;
            display: none;
        }

        .infoSpn {
            font-size: 1.6em;
            font-weight: bolder;
            border: dashed 2px #D32F2F;
            color: #B71C1C;
            padding: 0.1em;
            padding-left: 0.8em;
            padding-right: 0.8em;
            margin-right: 1em;
            margin-left: 1em;
            border-radius: 100%;
            display: inline-block;
            transition: all 1s ease
        }

        .inputDiv {
            padding: 0;
            max-height: 0;
            margin: 1em 0;
            overflow: hidden;
            transition: all 1s ease;
            text-align: center;
        }

        .myForm {
            margin: 0 0 2em 0;
            transition: all 1s ease;
        }

        .btn {
            width: 42%;
            margin: .4em 1em;
        }

        @media (max-width: 600px) {
            .btn-text {
                display: none;
            }

            .btn {
                width: 90%;
                margin: .4em 1em;
            }
        }

        #gameTitle {
            cursor: pointer;
        }

        #save_name:invalid {
            box-shadow: 0 0 0 1px #e74c3c;
        }

        #save_name:valid:focus {
            border-color: #8bc34a;
            box-shadow: 0 0 0 1px #8bc34a;
        }

        #save_name:disabled {
            border-color: #535353;
            box-shadow: none;
            border-style: dashed solid;
            border-width: medium;
        }

        @-webkit-keyframes pulse {
            0% {
                -webkit-box-shadow: 0 0 0 0 rgba(139, 195, 74, 0.4);
            }

            70% {
                -webkit-box-shadow: 0 0 0 10px rgba(139, 195, 74, 0);
            }

            100% {
                -webkit-box-shadow: 0 0 0 0 rgba(139, 195, 74, 0);
            }
        }

        @keyframes pulse {
            0% {
                -moz-box-shadow: 0 0 0 0 rgba(139, 195, 74, 0.4);
                box-shadow: 0 0 0 0 rgba(139, 195, 74, 0.4);
            }

            70% {
                -moz-box-shadow: 0 0 0 10px rgba(139, 195, 74, 0);
                box-shadow: 0 0 0 10px rgba(139, 195, 74, 0);
            }

            100% {
                -moz-box-shadow: 0 0 0 0 rgba(139, 195, 74, 0);
                box-shadow: 0 0 0 0 rgba(139, 195, 74, 0);
            }
        }
    </style>
    <style id="temp_style"></style>
</head>

<body
    onkeydown="$('#save_name').is(':focus') ? '' : ($('.image.fit > div, iframe')[0]?.scrollIntoView(), document.getElementById('gameFrame')?.contentWindow.focusMe()); $('.infoDiv').fadeOut(1000);">
    <img src="fullS.png" width="24" height="24" title="FullScreen"
        style="display: inline; top: 0.3em; position: fixed; z-index:+1; right: 0.3em; cursor: pointer; fill: #f44336"
        id="fsbutton" onclick="document.getElementById('gameFrame')?.contentWindow.clickMe();">
    <span class="fa-stack" title="GamePads"
        style="display: inline; line-height: 1.15; top: 0.3em; left: 0.15em; position: fixed; z-index:+1; color: #f44336; cursor: pointer;"
        id="gamepadicon" onclick="keybPrimaryPlayer.toggle()">
        <i class="fa fa-gamepad fa-stack-2x" style="line-height: 0.4;"></i>
    </span>
    <img src="" id="forColorThief" style="display: none;">
    <header id="header" class="preview">
        <div class="inner" onClick="document.getElementById('homeButton').click();" style="cursor: pointer;">
            <div class="content">
                <h1>Retro Game Zone</h1>
                <h2>A place for all nostalgic gamers to relive old memories.</h2>
                <a href="index.html" class="button big alt">
                    <span>Let's Play</span>
                </a>
            </div>
            <a href="index.html" class="button hidden" id="homeButton">
                <span>Let's Play</span>
            </a>
        </div>
    </header>
    <div id="preview">
        <div class="inner">
            <div class="image fit">
                <iframe name="gameFrame" id="gameFrame" src="index2.html"
                    style="width: 100%; height: 693px; transition: all 0.9s; margin-top: 15px;" scrolling="no"></iframe>
                <div id="game"></div>
            </div>
            <div class="content">
                <header>
                    <center>
                        <h2 id="gameTitle">&nbsp;</h2>
                    </center>
                    <div id="gameName" style="display: none;">&nbsp;</div>
                </header>
                <div class="inputDiv">
                    <form class="myForm" onsubmit="return validateForm()">
                        <input style="text-align: center;" type="search" id="save_name"
                            placeholder="enter a unique save name"
                            pattern="^(?=.{1,20}$)(?![_\-])(?!.*[_\-]{2})[a-zA-Z0-9\-_]+(?<![_\-])"
                            title="only alphabets followed by numbers or hyphen(-) are allowed, don't use spaces or special characters"
                            maxlength="20" autocorrect="off" autocapitalize="none">
                    </form>
                    <button class="btn" onclick="dwnSaveState()"><i class="fa fa-lg fa-floppy-o" aria-hidden="true"></i>
                        <span class="btn-text">Download Save File</span></button>
                    <button class="btn" onclick="opnSaveState()"><i class="fa fa-lg fa-cloud-upload"
                            aria-hidden="true"></i> <span class="btn-text">Upload Save File</span></button>
                </div>
                <div class="infoDiv chrome">
                    <center>
                        <span class="infoSpn">!</span>
                        <div style="display: inline-block; color: #212121;">Please Use the <big>Chrome</big> Browser
                            Only. Don't use any other Browser.</div>
                    </center>
                </div>
                <div class="infoDiv mob">
                    <center>
                        <span class="infoSpn">!</span>
                        <div style="display: inline-block; color: #212121;">You Can Connect USB OTG or Bluetooth
                            KEYBOARD to your Device to Play The Game.</div>
                    </center>
                </div>
                <h4 style="font-size: x-large; color: #e74c3c;">
                    Controls
                    <i class="fa fa-exchange" onclick="keybPrimaryPlayer.toggle()" title="Swap Players"
                        style="cursor: pointer; color: rgb(244, 67, 54);"></i>
                </h4>
                <img class="controllers" src="//cdn.jsdelivr.net/gh/omssp/nesscraper/images/controller1.png"
                    alt="Controller 1" />
                <img class="controllers" src="//cdn.jsdelivr.net/gh/omssp/nesscraper/images/controller2.png"
                    alt="Controller 2" />
                <center>
                    <table id="controls">
                        <tr>
                            <th>Button</th>
                            <th>Player 1</th>
                            <th>Player 2</th>
                        </tr>
                        <tr>
                            <td>Left</td>
                            <td>A</td>
                            <td>Left</td>
                        <tr>
                            <td>Right</td>
                            <td>D</td>
                            <td>Right</td>
                        </tr>
                        <tr>
                            <td>Up</td>
                            <td>W</td>
                            <td>Up</td>
                        </tr>
                        <tr>
                            <td>Down</td>
                            <td>S</td>
                            <td>Down</td>
                        </tr>
                        <tr>
                            <td>A</td>
                            <td>L</td>
                            <td>NUM - .</td>
                        </tr>
                        <tr>
                            <td>B</td>
                            <td>K</td>
                            <td>NUM - 0</td>
                        </tr>
                        <tr>
                            <td>Start</td>
                            <td>H / Enter</td>
                            <td>NUM - 2</td>
                        </tr>
                        <tr>
                            <td>Select</td>
                            <td>G / Ctrl</td>
                            <td>NUM - 1</td>
                        </tr>
                    </table>
                </center>

                <p>
                    <br /> Keyboard Shortcuts &nbsp;-<br>
                    <center>
                        <span class="infospan">M : Mute/UnMute</span>
                        <span class="infospan">P : Swap Players</span>
                        <span class="infospan">R : Power/Reset</span>
                        <span class="infospan">F : Immersive Mode</span>
                        <span class="infospan">SHIFT + LEFT : Previous Game</span>
                        <span class="infospan">SHIFT + RIGHT : Next Game</span>
                        <span class="infospan">SHIFT + UP : Home</span>
                        <span class="infospan">SPACEBAR : Pause/Resume</span>
                        <!--span class="infospan">BACKSPACE : Go To HOME</span-->
                    </center>
                </p>
            </div>
        </div>
        <a href="game.html" class="nav previous" id="previousGame">
            <span class="fa fa-chevron-left"></span>
        </a>
        <a href="game.html" class="nav next" id="nextGame">
            <span class="fa fa-chevron-right"></span>
        </a>
    </div>
    <footer id="footer">
        <a style="cursor: pointer!important;" class="info fa fa-info-circle">
            <span>About</span>
        </a>
        <div class="inner">
            <div class="content">
                <h3 style="margin: 0 0 0 0; font-size:23px;">
                    A website by <a href="https://www.fb.com/omssp" target="_blank">Shardul Pakhale</a>
                </h3>
            </div>
            <div class="copyright" style="text-align: right;">
                &copy; Shardul Pakhale | Moblie:
                <small>
                    <a href="tel: +918793687422">+918793687422</a>
                </small> | Visit: <a href="http://vomkar.droppages.com" target="_blank">Vomkar's Creations</a>
            </div>
        </div>
    </footer>
    <script src="assets/js/jquery.min.js"></script>
    <script src="MaterialColorThief.js"></script>
    <script src="lib/gamelist.js"></script>
    <script src="lib/swapplayers.js"></script>
    <script src="lib/audioUI.js"></script>
    <script src="lib/slugify.js"></script>
    <script src="lib/cookie.js"></script>
    <script src="emu/save.js"></script>
    <script src="emu/emu.js"></script>
    <script>

        const materialColorThief = new MaterialColorThief();

        var keybPrimaryPlayer = new KeyboardPrimaryPlayer();

        var para = 1;
        var url = document.location.href;
        if (url.indexOf('?') != -1) {
            para = parseInt(url.split('?')[1].split('&')[0]);
        }
        window.onload = function () {

            document.getElementById('gameName').innerHTML = window.EJS_gameUrl = gameNameArray[para][1];
            document.getElementById('gameTitle').innerHTML = document.title = window.EJS_gameName = gameNameArray[para][0];


            let currHrs = new Date().getHours();
            const darkMode = (currHrs > 18 || currHrs < 6) || window.matchMedia("(prefers-color-scheme: dark)").matches;

            let rgbVals = '33,33,33';

            let imagetag = document.getElementById('forColorThief');
            imagetag.crossOrigin = "anonymous";
            imagetag.src = gameNameArray[para][2];

            $(imagetag).load(() => {

                if (darkMode) {
                    $('body, table th').css('color', '#eeeeee');
                    $('#gameFrame').contents().find('.nes-status').css('color', '#eeeeee');
                    $('#fsbutton, #gamepadicon, .nav').css('filter', 'drop-shadow(0 0 1px #fafafa)');
                    $('#gameFrame').contents().find('#mubutton, #powbutton, #ppbutton').css('filter', 'drop-shadow(0 0 2px #9e9e9e)');
                    $('#gameTitle, h4').css('text-shadow', '0px 0px 20px #9e9e9e');
                    rgbVals = materialColorThief.getDarkestMaterialColor(imagetag).join(',');
                } else {

                    rgbVals = materialColorThief.getBrightestMaterialColor(imagetag).join(',');
                }

                updateBackgrounds(rgbVals);
            });


        };
        const updateBackgrounds = (backgroundColorRGB) => {
            $('body, .nav').css("background-color", `rgb(${backgroundColorRGB})`);
            $('#header .inner').css("box-shadow", `0 0 0 1em rgb(${backgroundColorRGB})`);
            $('#footer > a').css("color", `rgb(${backgroundColorRGB})`);
            $('#header.hide .button.hidden, #header.preview .button.hidden').attr('data-content', `rgb(${backgroundColorRGB})`)
        }

        $('.controllers').hover(function () {
            $(this).css('cursor', "url('controls/nespad.ico'), auto");
        });
        let debounce;
        $(window).resize(function () {
            if (debounce)
                clearTimeout(debounce)
            debounce = setTimeout(() => {
                // alert($(window).width());
                checkWidth(document.documentElement.offsetWidth);
            }, 1300);
        });
        $(document).ready(function () {
            const saveName = getCookie('save_name')?.trim()
            if (saveName) {
                save_name.val(saveName)
                save_name.blur()
            }
            if (window.history && window.history.pushState) {
                window.history.pushState('forward', null, '');
                $(window).on('popstate', function () {
                    window.location.replace('index.html');
                });
            }
            var isMobile = ('ontouchstart' in document.documentElement);
            if (isMobile == true) {
                $(".infoDiv.mob").fadeIn(1000);
            }
            var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            if (isChrome == false) {
                $(".infoDiv.chrome").fadeIn(1000);

                if (isMobile &&
                    !(document.documentElement.requestFullscreen ||
                        document.documentElement.mozRequestFullScreen ||
                        document.documentElement.webkitRequestFullscreen ||
                        document.documentElement.msRequestFullscreen)) {
                    $('#fsbutton').fadeOut("slow");
                }
            }
            window.addEventListener("gamepadconnected", (event) => {
                $('#gamepadicon').fadeIn("slow");
                keybPrimaryPlayer.setSwapped();
                checkandchange();
                console.log("A gamepad connected:");
                console.log(event.gamepad);
            });
            window.addEventListener("gamepaddisconnected", (event) => {
                $('#gamepadicon').fadeOut("slow");
                keybPrimaryPlayer.resetSwapped();
                checkandchange();
                console.log("A gamepad disconnected:");
                console.log(event.gamepad);
            });
            $('#gamepadicon').fadeOut("slow");

            if (debounce)
                clearTimeout(debounce)
            debounce = setTimeout(function () {
                checkWidth(document.documentElement.offsetWidth);
            }, 1300);

            var nexG = (para + 1) % gameNameArray.length;
            var preG = para - 1;
            if (preG < 0)
                preG = gameNameArray.length - 1;
            $('#previousGame').attr("href", "game.html?" + preG.toString());
            $('#nextGame').attr("href", "game.html?" + nexG.toString());

            $("a").each(function () {
                let thref = $(this).attr('href');
                if (thref) {
                    $(this).removeAttr('href');
                    $(this).css("cursor", "pointer");
                    $(this).unbind("click").on("click", function () {
                        window.selectAudio.playclip();
                        window.setTimeout(() => {
                            window.location.replace(thref);
                        }, window.selectAudio.duration * 1000);
                    });
                }
            });
            setTimeout(checkandchange, 1000);
        });

        function checkWidth(curWidth) {
            let nesCanvas = $('#gameFrame').contents().find('#nescanvas');
            if (curWidth < 500 && nesCanvas[0]?.offsetHeight > 400) {
                nesCanvas.click();
            } else if (curWidth > 500 && nesCanvas[0]?.offsetHeight < 245) {
                nesCanvas.click();
            }
        }
        $(window).scroll(function () {
            currentScroll = $(window).scrollTop();
            if (currentScroll > 20) {
                window.focus();
                $('#header.preview').css("z-index", '0');
            } else {
                $('#header.preview').css("z-index", '1');
            }
        });

        function checkandchange() {
            const initial_gamepads = window.navigator.getGamepads().filter(o => o).length;
            const isMobile = ('ontouchstart' in document.documentElement);
            console.log(initial_gamepads)
            if (isMobile && !initial_gamepads) {
                loadEMU();
            } else if (!$('#gameFrame').length) {
                unLoadEMU();
            }
        }

        function loadEMU() {
            const gameFrame = document.getElementById('gameFrame');
            if (gameFrame) {
                gameFrame.remove();
                $('.image.fit').css("padding-top", '4em');

                const script = document.createElement("script");
                script.src = "emu/data/loader.js";
                script.id = 'loaderJS';
                document.body.appendChild(script)
                $('#fsbutton').click(function () {
                    $('button[data-btn="fullscreen"]').click();
                });

                const saveName = getCookie('save_name')?.trim()
                if (saveName) {
                    window.saver = new SaveHandler(saveName);
                    window.EJS_onSaveState = (e) => window.saver.saveToOnline(e)
                    window.EJS_onGameStart = (e) => window.saver.loadFromOnline(e)
                }
            }
        }

        function unLoadEMU() {
            const loaderJS = document.getElementById('loaderJS');
            if (loaderJS) {
                loaderJS.remove();
                window.EJS_terminate()
                $('#fsbutton').off('click');
                $('.image.fit').css("padding-top", 'auto').html(`<iframe name="gameFrame" id="gameFrame" src="index2.html" style="width: 100%; height: 693px; transition: all 0.9s; margin-top: 15px;" scrolling="no"></iframe>
                <div id="game"></div>`);
            }
        }
        let debounce_input;
        let debounce_toggle;
        let old_input;
        const save_name = $('#save_name').on('keyup blur paste search', debounceChange);
        const inputDiv = $('.inputDiv');
        function validateForm() {
            if (debounce_input)
                clearTimeout(debounce_input)
            if (save_name.is(':valid')) {
                old_input = save_name.css('animation', 'none').val().trim();
                save_name.attr('disabled', true).css('cursor', 'copy').attr('title', 'click to edit').blur();

                setCookie('save_name', old_input, 365)

                window.saver = new SaveHandler(old_input);
                if (window.EJS_emulator) {
                    window.EJS_emulator.config.onsavestate = old_input ? (e) => window.saver.saveToOnline(e) : null;
                    window.EJS_emulator.on('start-game', window.saver.loadFromOnline)
                    saver.loadFromOnline()
                }

                if (debounce_toggle)
                    clearTimeout(debounce_toggle)
                setTimeout(() => {
                    toggleSecretSave('hide');
                }, 15000);
            }
            return false;
        }
        function debounceChange() {
            let new_input = save_name.val().replaceAll(' ', '-');
            save_name.val(new_input);
            if (old_input != new_input) {
                save_name.css('animation', 'pulse 1s infinite')
                if (debounce_input)
                    clearTimeout(debounce_input)
                if (debounce_toggle)
                    clearTimeout(debounce_toggle)
                debounce_input = setTimeout(() => {
                    validateForm();
                }, 2000);
            }
        }
        $('.inputDiv .myform').on('click', () => {
            if (save_name.is(':disabled')) {
                save_name.attr('disabled', false).css('cursor', 'auto').attr('title', "only alphabets followed by numbers or hyphen(-) are allowed, don't use spaces or special characters")
            }
        });

        const toggleSecretSave = (hide) => {
            if (!window.EJS_emulator) return;
            if (inputDiv.css('max-height') == "200px" || hide === 'hide') {
                inputDiv.css('max-height', "0");
                inputDiv.css('padding', "0");
            } else {
                inputDiv.css('max-height', "200px");
                inputDiv.css('padding', "1em");
                if (debounce_toggle)
                    clearTimeout(debounce_toggle)
                setTimeout(() => {
                    toggleSecretSave('hide');
                }, 15000);
            }
        }

        $('#gameTitle').on('click', toggleSecretSave);

        const dwnSaveState = () => {
            if (window.EJS_emulator) {
                window.EJS_emulator.config.onsavestate = null;
                $('button[data-btn="save-state"]').click();
                setTimeout(() => {
                    window.EJS_emulator.config.onsavestate = (e) => window.saver.saveToOnline(e);
                }, 500);
                if (debounce_toggle)
                    clearTimeout(debounce_toggle)
                setTimeout(() => {
                    toggleSecretSave('hide');
                }, 15000);
            }
        }
        const opnSaveState = () => {
            if (window.EJS_emulator) {
                window.EJS_emulator.game.stateloadField.click()
                if (debounce_toggle)
                    clearTimeout(debounce_toggle)
                setTimeout(() => {
                    toggleSecretSave('hide');
                }, 15000);
            }
        }
    </script>
    <script src="assets/js/skel.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
</body>

</html>
